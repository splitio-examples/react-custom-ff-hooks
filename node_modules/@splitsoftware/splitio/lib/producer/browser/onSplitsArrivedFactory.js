"use strict";

var _interopRequireDefault = require("@babel/runtime-corejs3/helpers/interopRequireDefault");

var _Object$defineProperty = require("@babel/runtime-corejs3/core-js-stable/object/define-property");

_Object$defineProperty(exports, "__esModule", {
  value: true
});

exports.default = onSplitsArrivedCtx;

var _logger = _interopRequireDefault(require("../../utils/logger"));

var log = (0, _logger.default)('splitio-producer:mySegmentsHandler');

function onSplitsArrivedCtx(segmentsUpdaterTask, context) {
  var syncingSegments = true;
  var splitsStorage = context.get(context.constants.STORAGE).splits;

  var _context$get = context.get(context.constants.READINESS),
      segmentsEventEmitter = _context$get.segments;

  return function onSplitsArrived() {
    var splitsHaveSegments = splitsStorage.usesSegments();

    if (splitsHaveSegments !== syncingSegments) {
      syncingSegments = splitsHaveSegments;
      log.info("Turning segments data polling ".concat(splitsHaveSegments ? 'ON' : 'OFF', "."));

      if (splitsHaveSegments) {
        segmentsUpdaterTask.start();
      } else {
        var isReady = context.get(context.constants.READY, true);
        if (!isReady) segmentsEventEmitter.emit(segmentsEventEmitter.SDK_SEGMENTS_ARRIVED);
        segmentsUpdaterTask.stop();
      }
    }
  };
}